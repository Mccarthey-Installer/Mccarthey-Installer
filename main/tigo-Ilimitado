#!/bin/bash
echo "ðŸ”° Script MCCARTHEY - SSL 443 â†’ SSH 22 (AutomÃ¡tico, sin menÃº)"
set -e
export TZ="America/El_Salvador"

# === Actualizar sistema ===
sudo apt update -y && sudo apt upgrade -y

# === Instalar dependencias necesarias ===
sudo apt install -y stunnel4 locales openssl

# === Configurar idioma y zona horaria ===
sudo sed -i '/es_SV.UTF-8/s/^# //g' /etc/locale.gen
sudo locale-gen
sudo update-locale LANG=es_SV.UTF-8
sudo timedatectl set-timezone America/El_Salvador

# === Detener servicios previos ===
pkill -f stunnel4 || true
systemctl stop stunnel4 2>/dev/null || true

# === Variables principales ===
LOCAL_PORT=22
SSL_PORT=443
SNI_HOST="pruebat.org"

# === Generar certificado SSL automÃ¡tico (CN = pruebat.org) ===
echo "ðŸ§¾ Generando certificado SSL automÃ¡tico (CN: $SNI_HOST)..."
mkdir -p /etc/stunnel/certs
openssl req -x509 -newkey rsa:2048 -keyout /etc/stunnel/certs/stunnel.key \
  -out /etc/stunnel/certs/stunnel.crt -days 3650 -nodes -batch \
  -subj "/C=SV/ST=San Salvador/L=Santa Ana/O=McCartheyVPN/OU=SSLService/CN=$SNI_HOST/emailAddress=admin@mccarthey.net"

cat /etc/stunnel/certs/stunnel.key /etc/stunnel/certs/stunnel.crt > /etc/stunnel/certs/stunnel.pem
chmod 600 /etc/stunnel/certs/stunnel.pem

# === Configurar Stunnel: 443 â†’ 22 (directo) ===
echo "âš™ï¸ Configurando Stunnel: $SSL_PORT â†’ $LOCAL_PORT"
cat > /etc/stunnel/stunnel.conf <<EOF
pid = /var/run/stunnel4/stunnel.pid
setuid = stunnel4
setgid = stunnel4
debug = 5
output = /var/log/stunnel4/stunnel.log

cert = /etc/stunnel/certs/stunnel.pem
client = no
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1

[ssh]
accept = $SSL_PORT
connect = 127.0.0.1:$LOCAL_PORT
EOF

# === Habilitar Stunnel al inicio ===
sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/stunnel4
systemctl enable stunnel4
systemctl restart stunnel4

# === Verificar arranque automÃ¡tico ===
cat > /etc/rc.local <<'EOF'
#!/bin/bash
exit 0
EOF
chmod +x /etc/rc.local

cat > /etc/systemd/system/rc-local.service <<'EOF'
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable rc-local
systemctl start rc-local

# === Mensaje final ===
echo ""
echo "ðŸŸ¢ MCCARTHEY SSL TUNNEL (AUTOMÃTICO)"
echo "========================================"
echo "SSL: $SSL_PORT â†’ $LOCAL_PORT (SSH directo)"
echo "Certificado: CN = $SNI_HOST"
echo "SNI en cliente: $SNI_HOST"
echo ""
echo "âš™ï¸ ConfiguraciÃ³n para HTTP Custom (SIN payload):"
echo "   â€¢ Host: TU_IP"
echo "   â€¢ Puerto: 443"
echo "   â€¢ SNI: $SNI_HOST"
echo "   â€¢ SSH: 127.0.0.1:22"
echo "   â€¢ Payload: [VACÃO]"
echo ""
echo "ðŸ”Ž VerificaciÃ³n rÃ¡pida:"
echo "   ss -tulnp | grep 443"
echo "   systemctl status stunnel4"
echo ""
echo "âœ… InstalaciÃ³n completada correctamente."
echo "========================================"
echo ""

exit 0
