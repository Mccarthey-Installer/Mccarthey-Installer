#!/bin/bash
echo "âœ… Script MCCARTHEY - SSL 443 â†’ SSH 22 (SIN HTTP)"
set -e
export TZ="America/El_Salvador"

# Actualizar sistema
sudo apt update -y && sudo apt upgrade -y

# Instalar dependencias
sudo apt install -y stunnel4 netcat-openbsd screen locales

# Configurar zona horaria
sudo sed -i '/es_SV.UTF-8/s/^# //g' /etc/locale.gen
sudo locale-gen
sudo update-locale LANG=es_SV.UTF-8
sudo timedatectl set-timezone America/El_Salvador

# ===========================
# 1. STUNNEL: 443 â†’ 80
# ===========================
echo "ðŸ” Configurando Stunnel (443 â†’ 80)..."

# Remover stunnel viejo
sudo apt remove --purge -y stunnel4 > /dev/null 2>&1 || true
sudo apt install -y stunnel4

# Generar certificado self-signed (CN = pruebat.org)
mkdir -p /etc/stunnel/certs
openssl req -x509 -newkey rsa:2048 -keyout /etc/stunnel/certs/stunnel.key \
  -out /etc/stunnel/certs/stunnel.crt -days 3650 -nodes \
  -subj "/C=SV/ST=San Salvador/L=Santa Ana/O=McCartheyVPN/OU=SSL/CN=pruebat.org/emailAddress=admin@mccarthey.net"

cat /etc/stunnel/certs/stunnel.key /etc/stunnel/certs/stunnel.crt > /etc/stunnel/certs/stunnel.pem
chmod 600 /etc/stunnel/certs/stunnel.pem

# Config Stunnel: 443 â†’ 127.0.0.1:80
cat > /etc/stunnel/stunnel.conf <<EOF
pid = /var/run/stunnel4/stunnel.pid
setuid = stunnel4
setgid = stunnel4
debug = 7
output = /var/log/stunnel4/stunnel.log

cert = /etc/stunnel/certs/stunnel.pem
client = no
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1

[ssh]
accept = 443
connect = 127.0.0.1:80
EOF

# Habilitar stunnel
sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/stunnel4
systemctl enable stunnel4
systemctl restart stunnel4

# ===========================
# 2. TUNNEL DIRECTO 80 â†’ 22 (sin HTTP)
# ===========================
echo "ðŸ”€ Configurando tunnel directo 80 â†’ 22 (SSH local)..."

# Matar procesos previos
pkill -f "nc -l" || true
pkill -f badvpn-udpgw || true
screen -S tunnel -X quit || true

# Iniciar tunnel con netcat (puerto 80 â†’ 22)
screen -dmS tunnel bash -c 'while true; do nc -l -p 80 -q 1 < /dev/null | nc 127.0.0.1 22; done'

# ===========================
# 3. AUTOINICIO
# ===========================
cat > /etc/rc.local <<'EOF'
#!/bin/bash
sleep 10
screen -dmS tunnel bash -c 'while true; do nc -l -p 80 -q 1 < /dev/null | nc 127.0.0.1 22; done'
exit 0
EOF
chmod +x /etc/rc.local

cat > /etc/systemd/system/rc-local.service <<'EOF'
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable rc-local
systemctl start rc-local

# ===========================
# 4. MENSAJE FINAL
# ===========================
echo ""
echo "========================================"
echo "âœ… MCCARTHEY SSL TUNNEL LISTO"
echo "ðŸ”’ Stunnel: 443 â†’ 80"
echo "ðŸ”€ Tunnel directo: 80 â†’ 22 (SSH local)"
echo "ðŸ“¡ Puertos activos:"
ss -tulnp | grep -E ':80|:443' || true
echo ""
echo "ðŸ“± En HTTP Custom:"
echo "   â€¢ Host: TU_IP"
echo "   â€¢ Puerto: 443"
echo "   â€¢ SNI: pruebat.org"
echo "   â€¢ SSH: 127.0.0.1:22"
echo "   â€¢ SIN payload (directo)"
echo "========================================"
echo ""
