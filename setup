#!/bin/bash

# ========================
# McCarthey Installer v1.0
# Validación de KEY remota
# ========================

# Obtenemos la key del argumento
KEY="$1"

# Si no se pasa una key, se solicita al usuario
if [ -z "$KEY" ]; then
    echo -e "\n[ INFO ] No se proporcionó una MCC-KEY."
    read -p "Ingresa tu MCC-KEY: " KEY
fi

# Codificamos {} para la URL
ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')

# URL del validador en la VPS
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

# Llamada a la API de validación
echo -e "\n[ INFO ] Verificando KEY con el servidor..."
RESPONSE=$(curl -s "$VALIDATOR_URL")

# Revisamos si la key es válida
VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n[ ERROR ] Key inválida: $MOTIVO"
    exit 1
fi

echo -e "\n[ OK ] Key válida. Continuando con la instalación..."
echo -e "\n[ INSTALADOR ] Ejecutando configuración McCarthey..."

# Actualización inicial
apt update -y && apt upgrade -y
apt install -y curl unzip wget

# Lista de paquetes a instalar
PAQUETES=(
  bsdmainutils screen nginx nload htop python python3 python3-pip
  nodejs npm lsof psmisc socat bc netcat net-tools cowsay nmap jq iptables
)

# Instalación con mensaje formateado
for paquete in "${PAQUETES[@]}"; do
  if apt install -y "$paquete" >/dev/null 2>&1; then
    echo -e "- [ '05 ] INSTALACION CORRECTA ${paquete^^}"
  else
    echo -e "- [ '05 ] ERROR AL INSTALAR ${paquete^^}"
  fi
done

echo -e "\n[ LISTO ] Instalación completada con éxito."
