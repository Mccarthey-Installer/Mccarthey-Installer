#!/bin/bash

# ========================
# McCarthey Installer v1.0
# Validación de KEY remota
# ========================

# Obtenemos la key del argumento
KEY="$1"

# Si no se pasa una key, se solicita al usuario
if [ -z "$KEY" ]; then
    echo -e "\n[ INFO ] No se proporcionó una MCC-KEY."
    read -p "Ingresa tu MCC-KEY: " KEY
fi

# Codificamos {} para la URL
ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')

# URL del validador en la VPS
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

# Banner profesional
clear
echo -e "\e[1;36m"
echo "╔═══════════════════════════════════════╗"
echo "║         McCarthey VPN Installer      ║"
echo "║     © 2025 - All rights reserved     ║"
echo "╚═══════════════════════════════════════╝"
echo -e "\e[0m"

# Validación
echo -e "\n>> Validando clave de instalación..."
RESPONSE=$(curl -s "$VALIDATOR_URL")
VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n[ ERROR ] Key inválida: $MOTIVO"
    exit 1
fi

echo -e "\n[ OK ] Clave aceptada. Iniciando despliegue de servicios..."

# ========================
# Instalación de paquetes
# ========================

apt update -y && apt upgrade -y

# Función para instalar y mostrar estado
instalar() {
    apt install -y $1 &>/dev/null
    if [ $? -eq 0 ]; then
        echo -e "[ '05 ] INSTALACION CORRECTA ${1^^}"
    else
        echo -e "[ FAIL ] ERROR AL INSTALAR ${1^^}"
    fi
}

PAQUETES=(
    bsdmainutils
    usermod
    screen
    nginx
    nload
    htop
    python
    python3
    python3-pip
    nodejs
    npm
    lsof
    psmisc
    socat
    bc
    netcat
    net-tools
    cowsay
    nmap
    jq
    iptables
)

for pkg in "${PAQUETES[@]}"; do
    instalar "$pkg"
done

# Mensaje final bacano
echo -e "\n\e[1;32m[ COMPLETADO ] ¡Tu VPS está lista para despegar!\e[0m"
echo -e "\e[1;34mPuedes iniciar tu configuración SSH/VPN con estilo McCarthey.\e[0m"
echo -e "\e[1;36m¡Gracias por confiar en nosotros!\e[0m"
