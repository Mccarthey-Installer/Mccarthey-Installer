#!/bin/bash

# ================================
# ███╗   ███╗ ██████╗ ██████╗ ███████╗
# ████╗ ████║██╔═══██╗██╔══██╗██╔════╝
# ██╔████╔██║██║   ██║██████╔╝█████╗  
# ██║╚██╔╝██║██║   ██║██╔═══╝ ██╔══╝  
# ██║ ╚═╝ ██║╚██████╔╝██║     ███████╗
# ╚═╝     ╚═╝ ╚═════╝ ╚═╝     ╚══════╝
#       McCarthey Installer v1.1
# Validación de KEY remota y panel opcional
# ================================

# ------------------------------
# [ ARGUMENTOS ]
# ------------------------------
ENABLE_PANEL=false
for arg in "$@"; do
    if [[ "$arg" == "--mccpanel" ]]; then
        ENABLE_PANEL=true
    fi
done

# ------------------------------
# [ OBTENER MCC-KEY ]
# ------------------------------
KEY="$1"
if [[ "$KEY" == "--mccpanel" ]]; then
    KEY=""
fi

if [ -z "$KEY" ]; then
    clear
    echo -e "\e[1;34m"
    echo "============================================="
    echo "           MCC-KEY NO PROPORCIONADA          "
    echo "============================================="
    echo -e "\e[0m"

    echo -e "\e[1;36m"
    echo "╔═══════════════════════════════════════════╗"
    echo "║           INGRESA TU MCC-KEY              ║"
    echo "╚═══════════════════════════════════════════╝"
    echo -e "\e[0m"

    read -p "> " KEY
fi

ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

echo -e "\n\033[1;34m[ INFO ]\033[0m Verificando KEY con el servidor..."
RESPONSE=$(curl -s "$VALIDATOR_URL")
VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n\033[1;31m[ ERROR ]\033[0m Key inválida: $MOTIVO"
    exit 1
fi

echo -e "\n\033[1;32m[ OK ]\033[0m Key válida. Continuando con la instalación..."

# ------------------------------
# [ ACTUALIZACIÓN DEL SISTEMA ]
# ------------------------------
echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m      ACTUALIZANDO SISTEMA Y PAQUETES          \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

apt update -y && apt upgrade -y

# Reiniciar procesos pendientes si está instalado
if command -v needrestart >/dev/null; then
    needrestart -r a
fi

apt install -y curl unzip wget

# ------------------------------
# [ INSTALACIÓN DE PAQUETES ]
# ------------------------------
PAQUETES=(
  bsdmainutils screen nginx nload htop python3 python3-pip
  nodejs npm lsof psmisc socat bc netcat net-tools cowsay
  nmap jq iptables
)

echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m          INSTALANDO PAQUETES NECESARIOS        \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

for paquete in "${PAQUETES[@]}"; do
    apt install -y "$paquete" &>/dev/null
    if dpkg -s "$paquete" &>/dev/null; then
        echo -e "\033[1;32m[ OK ]\033[0m Instalación correcta: ${paquete^^}"
    else
        echo -e "\033[1;31m[ FAIL ]\033[0m Error al instalar: ${paquete^^}"
    fi
done

# ------------------------------
# [ PANEL OPCIONAL McCARTHEY ]
# ------------------------------
if $ENABLE_PANEL; then
cat << 'EOF' > /root/menu.sh
#!/bin/bash
clear
echo -e "\e[1;32m
╔══════════════════════════════════════╗
║           PANEL McCARTHEY            ║
╚══════════════════════════════════════╝\e[0m"

FECHA=$(TZ=America/Guatemala date)
IP=$(curl -s ifconfig.me)
CPU=$(lscpu | grep "Model name" | awk -F ':' '{print $2}' | sed 's/^ *//')
CPUS=$(nproc)
SO=$(lsb_release -d | cut -f2)

echo ""
echo "FECHA        : $FECHA"
echo "IP VPS       : $IP"
echo "CPU's        : $CPUS"
echo "TIPO DE CPU  : $CPU"
echo "S.O          : $SO"
echo ""
echo "1) Crear nuevo usuario SSH"
echo "2) Salir"
echo ""
read -p "Elige una opción: " OPC

case $OPC in
  1)
    read -p "Nombre de usuario: " USUARIO
    read -p "Contraseña: " PASSWORD
    read -p "Días de validez: " DIAS
    useradd -e $(date -d "$DIAS days" +%Y-%m-%d) -s /bin/false -M $USUARIO
    echo "$USUARIO:$PASSWORD" | chpasswd
    echo ""
    echo "Usuario creado con éxito:"
    echo "Usuario: $USUARIO"
    echo "Contraseña: $PASSWORD"
    echo "Expira en: $DIAS días"
    ;;
  2)
    echo "Saliendo del panel..."
    exit 0
    ;;
  *)
    echo "Opción no válida."
    ;;
esac
EOF

chmod +x /root/menu.sh
ln -sf /root/menu.sh /usr/bin/menu
chmod +x /usr/bin/menu

echo -e "\n\033[1;36m[ PANEL ]\033[0m Panel McCarthey instalado y listo para usar."
echo "Ejecuta \033[1;33mmenu\033[0m para acceder."
fi

# ------------------------------
# [ FINALIZACIÓN ]
# ------------------------------
echo -e "\n\033[1;32m==============================================\033[0m"
echo -e "\033[1;32m      ¡TU VPS ESTÁ LISTA PARA DESPEGAR!         \033[0m"
echo -e "\033[1;32m==============================================\033[0m"
echo -e "Puedes acceder al panel usando: \033[1;33mmenu\033[0m"
echo -e "¡Gracias por usar \033[1;35mMcCarthey Installer\033[0m!"
