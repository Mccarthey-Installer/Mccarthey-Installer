#!/bin/bash

# ========================
# McCarthey Installer v1.0
# Validación de KEY remota
# ========================

# Obtenemos la key del argumento
KEY="$1"

# Si no se pasa una key, se detiene
if [ -z "$KEY" ]; then
    echo -e "\n[ ERROR ] No se proporcionó una MCC-KEY. Usa el comando así:"
    echo -e "bash <(curl -sSL https://TU_REPO/setup) MCC-KEY{xxxx-xxxx-xxxx-xxxx}"
    exit 1
fi

# Codificamos {} para la URL
ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')

# URL del validador en la VPS
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

# Llamada a la API de validación
echo -e "\n[ INFO ] Verificando KEY con el servidor..."
RESPONSE=$(curl -s "$VALIDATOR_URL")

# Revisamos si la key es válida
VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n[ ERROR ] Key inválida: $MOTIVO"
    exit 1
fi

echo -e "\n[ OK ] Key válida. Continuando con la instalación..."

# ========================
# Aquí empieza tu instalación real
# ========================

echo -e "\n[ INSTALADOR ] Ejecutando configuración McCarthey..."

# Ejemplo de comandos que podrías usar (rellena aquí lo tuyo)
apt update -y && apt upgrade -y
apt install -y curl unzip wget

# Más comandos personalizados...

echo -e "\n[ LISTO ] Instalación completada con éxito."
