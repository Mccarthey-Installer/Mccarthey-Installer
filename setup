#!/bin/bash

# ================================
# ███╗   ███╗ ██████╗ ██████╗ ███████╗
# ████╗ ████║██╔═══██╗██╔══██╗██╔════╝
# ██╔████╔██║██║   ██║██████╔╝█████╗  
# ██║╚██╔╝██║██║   ██║██╔═══╝ ██╔══╝  
# ██║ ╚═╝ ██║╚██████╔╝██║     ███████╗
# ╚═╝     ╚═╝ ╚═════╝ ╚═╝     ╚══════╝
#       McCarthey Installer v1.2
# ================================

# ARGUMENTOS
ENABLE_PANEL=false
for arg in "$@"; do
    if [[ "$arg" == "--mccpanel" ]]; then
        ENABLE_PANEL=true
    fi
done

# OBTENER MCC-KEY
KEY="$1"
if [[ "$KEY" == "--mccpanel" ]]; then
    KEY=""
fi

if [ -z "$KEY" ]; then
    clear
    echo -e "\e[1;34m"
    echo "============================================="
    echo "          having MCC-KEY NO PROPORCIONADA          "
    echo "============================================="
    echo -e "\e[0m"

    echo -e "\e[1;36m"
    echo "╔═══════════════════════════════════════════╗"
    echo "║           INGRESA TU MCC-KEY              ║"
    echo "╚═══════════════════════════════════════════╝"
    echo -e "\e[0m"

    read -p "> " KEY
fi

ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

echo -e "\n\033[1;34m[ INFO ]\033[0m Verificando KEY con el servidor..."
RESPONSE=$(curl -s "$VALIDATOR_URL")
VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n\033[1;31m[ ERROR ]\033[0m Key inválida: $MOTIVO"
    exit 1
fi

USERNAME=$(echo "$RESPONSE" | grep -oP '"username":"\K[^"]+')
echo -e "\n\033[1;32m[ OK ]\033[0m Key válida. Continuando con la instalación..."
echo -e "\033[1;34mKey: Verified【  $USERNAME  】\033[0m"

# ACTUALIZACIÓN DEL SISTEMA
echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m      ACTUALIZANDO SISTEMA Y PAQUETES          \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

apt update -y && apt upgrade -y
if command -v needrestart >/dev/null; then
    needrestart -r a
fi

apt install -y curl unzip wget

# INSTALACIÓN DE PAQUETES
PAQUETES=(
  bsdmainutils screen nginx nload htop python3 python3-pip
  nodejs npm lsof psmisc socat bc net-tools cowsay
  nmap jq iptables
)

echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m          INSTALANDO PAQUETES NECESARIOS        \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

for paquete in "${PAQUETES[@]}"; do
    apt install -y "$paquete" &>/dev/null
    if dpkg -s "$paquete" &>/dev/null; then
        echo -e "\033[1;32m[ OK ]\033[0m Instalación correcta: ${paquete^^}"
    else
        echo -e "\033[1;31m[ FAIL ]\033[0m Error al instalar: ${paquete^^}"
    fi
done

# PANEL
while true; do
  clear
  echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
  echo -e "          \e[1mPANEL OFICIAL MCCARTHEY\e[0m"
  echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
  echo -e " FECHA       : $fecha"
  echo -e " IP VPS      : $ip"
  echo -e " CPU's       : $cpus"
  echo -e " MODELO CPU  :$cpu_model"
  echo -e " S.O         : $so"
  echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
  echo -e " ∘ TOTAL: $ram_total  ∘ LIBRE: $ram_libre  ∘ EN USO: $ram_usada"
  echo -e " ∘ U/RAM: $ram_porc   ∘ U/CPU: $cpu_uso_fmt  ∘ BUFFER: $ram_cache"
  echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
  echo -e " [1] ➮ CREAR NUEVO USUARIO SSH"
  echo -e " [2] ➮ ACTUALIZAR MCC-KEY"
  echo -e " [3] ➮ SALIR"
  echo -e " [4] ➮ USUARIOS REGISTRADOS"
  echo -e " [5] ➮ ELIMINAR USUARIO(S)"
  echo -e "\e[1;32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
  read -p "► Elige una opción: " opc

  case $opc in
    1)
      read -p "Nombre de usuario: " USUARIO
      read -p "Contraseña: " PASSWORD
      read -p "Días de validez: " DIAS

      if [[ -z "$USUARIO" || -z "$PASSWORD" || -z "$DIAS" ]]; then
        echo ""
        echo -e "\e[1;31mPor favor complete todos los datos.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi

      FECHA_EXPIRACION=$(date -d "$DIAS days" +"%d/ de %B")
      useradd -e $(date -d "$DIAS days" +%Y-%m-%d) -s /bin/false -M $USUARIO
      echo "$USUARIO:$PASSWORD" | chpasswd
      echo "$USUARIO $PASSWORD $DIAS $FECHA_EXPIRACION" >> /root/.usuarios_mcc.txt
      echo ""
      echo "Usuario creado con éxito:"
      echo ""
      echo -e "\e[1;35m$(printf '%-12s %-14s %-10s %-15s %-5s' 'USUARIO' 'CONTRASEÑA' 'LIMITE' 'CADUCA' 'DIAS')\e[0m"
      printf "%-12s %-14s %-10s %-15s %-5s\n" "$USUARIO" "$PASSWORD" "1" "$FECHA_EXPIRACION" "$DIAS"
      echo ""
      read -p "Presiona enter para continuar..."
      ;;
    2)
      validar_key
      ;;
    3)
      echo "Saliendo del panel..."
      exit 0
      ;;
    4)
      clear
      echo -e "\e[1;33mUSUARIOS REGISTRADOS:\e[0m"
      if [[ ! -s /root/.usuarios_mcc.txt ]]; then
        echo -e "\e[1;31mLista vacía.\e[0m"
      else
        echo -e "\e[1;35m$(printf '%-12s %-14s %-10s %-15s %-5s' 'USUARIO' 'CONTRASEÑA' 'LIMITE' 'CADUCA' 'DIAS')\e[0m"
        while read usr pass dias caduca; do
          printf "%-12s %-14s %-10s %-15s %-5s\n" "$usr" "$pass" "1" "$caduca" "$dias"
        done < /root/.usuarios_mcc.txt
      fi
      echo ""
      read -p "Presiona enter para continuar..."
      ;;
    5)
      clear
      echo -e "\e[1;33mELIMINAR USUARIO(S)\e[0m"
      echo ""
      if [[ ! -s /root/.usuarios_mcc.txt ]]; then
        echo -e "\e[1;31mNo hay usuarios registrados para eliminar.\e[0m"
        read -p "Presiona enter para volver al panel..."
        continue
      fi

      echo -e "[1] ➤ Eliminar UN usuario"
      echo -e "[2] ➤ Eliminar TODOS los usuarios"
      echo ""
      read -p "Elige una opción: " delop

      case $delop in
        1)
          echo ""
          read -p "Nombre del usuario a eliminar: " USERDEL
          if id "$USERDEL" &>/dev/null; then
            userdel -f "$USERDEL"
            sed -i "/^$USERDEL /d" /root/.usuarios_mcc.txt
            echo -e "\e[1;32mUsuario '$USERDEL' eliminado correctamente.\e[0m"
          else
            echo -e "\e[1;31mEl usuario '$USERDEL' no existe.\e[0m"
          fi
          ;;
        2)
          read -p "¿Estás seguro de eliminar TODOS los usuarios? (s/n): " CONFIRMAR
          if [[ "$CONFIRMAR" == "s" || "$CONFIRMAR" == "S" ]]; then
            while read usr _; do
              userdel -f "$usr" &>/dev/null
            done < /root/.usuarios_mcc.txt
            > /root/.usuarios_mcc.txt
            echo -e "\e[1;32mTodos los usuarios han sido eliminados.\e[0m"
          else
            echo -e "\e[1;33mCancelado.\e[0m"
          fi
          ;;
        *)
          echo -e "\e[1;31mOpción inválida.\e[0m"
          ;;
      esac

      echo ""
      read -p "Presiona enter para volver al panel..."
      ;;
    *)
      echo "Opción no válida."
      sleep 2
      ;;
  esac
done

EOF

chmod +x /root/menu.sh
ln -sf /root/menu.sh /usr/bin/menu
chmod +x /usr/bin/menu

echo -e "\n\033[1;36m[ PANEL ]\033[0m Panel McCarthey instalado y listo para usar."
echo "Ejecuta \033[1;33mmenu\033[0m para acceder."

# FINAL
echo -e "\n\033[1;32m==============================================\033[0m"
echo -e "\033[1;32m      ¡TU VPS ESTÁ LISTA PARA DESPEGAR!         \033[0m"
echo -e "\033[1;32m==============================================\033[0m"
echo -e "Puedes acceder al panel usando: \033[1;33mmenu\033[0m"
echo -e "¡Gracias por usar \033[1;35mMcCarthey Installer\033[0m!"
