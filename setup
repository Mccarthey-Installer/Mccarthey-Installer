#!/bin/bash

API_URL="http://172.233.189.223:9090/validate_key"

clear
echo -e "\e[1;33m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo -e "\e[1;32m            Bienvenido al instalador\e[0m"
echo -e "\e[1;32m             Mccarthey V2.8 Oficial\e[0m"
echo -e "\e[1;33m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
echo
read -p $'\e[1;37mIngrese su KEY de instalación: \e[0m' user_key

# Validar KEY con API
echo -e "\nValidando KEY..."
RESPONSE=$(curl -s -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d "{\"key\": \"$user_key\"}")

STATUS=$(echo "$RESPONSE" | grep -o '"status":"[^"]*"' | cut -d':' -f2 | tr -d '"')
MESSAGE=$(echo "$RESPONSE" | grep -o '"message":"[^"]*"' | cut -d':' -f2- | tr -d '"')

if [[ "$STATUS" != "success" ]]; then
  echo -e "\n\e[1;31mERROR: $MESSAGE"
  echo -e "La instalación será cancelada.\e[0m"
  exit 1
fi

echo -e "\n\e[1;32mKEY válida. Continuando con la instalación...\e[0m"
sleep 2

# Actualizar sistema y eliminar warnings de hibernación
echo -e "\n>>> \e[1;33mActualizando sistema y preparando entorno...\e[0m"
apt update -y && apt upgrade -y
rm -f /etc/initramfs-tools/conf.d/resume
update-initramfs -u >/dev/null 2>&1

# Instalar paquetes necesarios
apt install net-tools curl wget zip unzip -y
apt install python3 python3-pip -y
apt install screen -y

# Iniciar menú McCarthey
while true; do
    clear
    echo -e "\e[1;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
    echo -e "\e[1;32m       Mccarthey-Panel | VPS Tool\e[0m"
    echo -e "\e[1;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
    echo -e "\e[1;37m[1] ➤ Instalar Servicios VPN"
    echo -e "[2] ➤ Crear Usuario SSH"
    echo -e "[3] ➤ Optimizar VPS"
    echo -e "[0] ➤ Salir"
    echo -e "\e[1;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
    read -p "Opción: " opc

    case $opc in
        1) echo -e "\e[1;33mInstalando servicios VPN...\e[0m"; sleep 2 ;;
        2) echo -e "\e[1;33mCreando usuario SSH...\e[0m"; sleep 2 ;;
        3) echo -e "\e[1;33mOptimizando VPS...\e[0m"; sleep 2 ;;
        0) echo -e "\e[1;31mSaliendo...\e[0m"; exit 0 ;;
        *) echo -e "\e[1;31mOpción inválida\e[0m"; sleep 1 ;;
    esac
done