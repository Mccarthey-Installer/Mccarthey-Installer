#!/bin/bash

# ================================
# ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
# ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
# ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
# ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
#       McCarthey Installer v1.2
# ================================

# ARGUMENTOS
ENABLE_PANEL=false
ENABLE_PROXY=true  # Por defecto, instalamos proxy.py para todos
for arg in "$@"; do
    if [[ "$arg" == "--mccpanel" ]]; then
        ENABLE_PANEL=true
    fi
    if [[ "$arg" == "--proxy" ]]; then
        ENABLE_PROXY=true
    fi
done

# OBTENER MCC-KEY
KEY=""
for arg in "$@"; do
    if [[ "$arg" != "--mccpanel" && "$arg" != "--proxy" ]]; then
        KEY="$arg"
        break
    fi
done

if [ -z "$KEY" ]; then
    clear
    echo -e "\e[1;34m"
    echo "============================================="
    echo "          having MCC-KEY NO PROPORCIONADA          "
    echo "============================================="
    echo -e "\e[0m"

    echo -e "\e[1;36m"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           INGRESA TU MCC-KEY              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "\e[0m"

    read -p "> " KEY
fi

ENCODED_KEY=$(echo "$KEY" | sed 's/{/%7B/' | sed 's/}/%7D/')
VALIDATOR_URL="http://172.235.128.99:9393/validate/$ENCODED_KEY"

# Mejorar validaci√≥n con reintentos
echo -e "\n\033[1;34m[ INFO ]\033[0m Verificando KEY con el servidor..."
for attempt in {1..3}; do
    RESPONSE=$(curl -s --connect-timeout 5 "$VALIDATOR_URL")
    if [ $? -eq 0 ]; then
        break
    fi
    echo -e "\033[1;33m[ WARN ]\033[0m Intento $attempt fall√≥. Reintentando..."
    sleep 2
done

if [ -z "$RESPONSE" ]; then
    echo -e "\n\033[1;31m[ ERROR ]\033[0m No se pudo contactar al servidor de validaci√≥n."
    exit 1
fi

VALIDO=$(echo "$RESPONSE" | grep -o '"valida":true')

if [ -z "$VALIDO" ]; then
    MOTIVO=$(echo "$RESPONSE" | grep -oP '"motivo":"\K[^"]+')
    echo -e "\n\033[1;31m[ ERROR ]\033[0m Key inv√°lida: $MOTIVO"
    exit 1
fi

USERNAME=$(echo "$RESPONSE" | grep -oP '"username":"\K[^"]+')
echo -e "\n\033[1;32m[ OK ]\033[0m Key v√°lida. Continuando con la instalaci√≥n..."
echo -e "\033[1;34mKey: Verified„Äê  $USERNAME  „Äë\033[0m"

# ACTUALIZACI√ìN DEL SISTEMA
echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m      ACTUALIZANDO SISTEMA Y PAQUETES          \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

apt update -y && apt upgrade -y
if command -v needrestart >/dev/null; then
    needrestart -r a
fi

apt install -y curl unzip wget

# INSTALACI√ìN DE PAQUETES
PAQUETES=(
  bsdmainutils screen nload htop python3 python3-pip
  nodejs npm lsof psmisc socat bc net-tools cowsay
  nmap jq iptables openssh-server dropbear
)

echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m          INSTALANDO PAQUETES NECESARIOS        \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

for paquete in "${PAQUETES[@]}"; do
    echo -e "\033[1;34m[ INFO ]\033[0m Instalando $paquete..."
    if ! apt install -y "$paquete"; then
        echo -e "\033[1;31m[ FAIL ]\033[0m Error al instalar: ${paquete^^}"
    elif dpkg -s "$paquete" &>/dev/null; then
        echo -e "\033[1;32m[ OK ]\033[0m Instalaci√≥n correcta: ${paquete^^}"
    else
        echo -e "\033[1;31m[ FAIL ]\033[0m Error al verificar: ${paquete^^}"
    fi
done

# CONFIGURAR OPENSSH EN PUERTO 22
echo -e "\n\033[1;33m==============================================\033[0m"
echo -e "\033[1;33m          CONFIGURANDO OPENSSH (PUERTO 22)      \033[0m"
echo -e "\033[1;33m==============================================\033[0m"

# Asegurarse de que OpenSSH est√© habilitado y corriendo
systemctl enable ssh &>/dev/null
systemctl start ssh &>/dev/null

# Verificar que OpenSSH est√© escuchando en el puerto 22
if ss -tuln | grep -q ":22 "; then
    echo -e "\033[1;32m[ OK ]\033[0m OpenSSH est√° activo en el puerto 22."
else
    # Intentar configurar el puerto 22 expl√≠citamente
    sed -i 's/^#Port 22/Port 22/' /etc/ssh/sshd_config
    systemctl restart ssh &>/dev/null
    if ss -tuln | grep -q ":22 "; then
        echo -e "\033[1;32m[ OK ]\033[0m OpenSSH configurado y activo en el puerto 22."
    else
        echo -e "\033[1;31m[ FAIL ]\033[0m No se pudo activar OpenSSH en el puerto 22."
    fi
fi

# Asegurarse de que ufw permita el puerto 22
ufw allow 22 &>/dev/null
ufw enable &>/dev/null
echo -e "\033[1;32m[ OK ]\033[0m Puerto 22 permitido en ufw."

# INSTALACI√ìN Y CONFIGURACI√ìN AUTOM√ÅTICA DE DROPBEAR Y PROXY.PY
if $ENABLE_PROXY; then
    echo -e "\n\033[1;33m==============================================\033[0m"
    echo -e "\033[1;33m      CONFIGURANDO DROPBEAR Y PROXY.PY         \033[0m"
    echo -e "\033[1;33m==============================================\033[0m"

    # Instalar Dropbear si no est√° instalado
    if ! dpkg -s dropbear &>/dev/null; then
        echo -e "\n[+] Instalando Dropbear..."
        apt install dropbear -y
        if dpkg -s dropbear &>/dev/null; then
            echo -e "\033[1;32m[ OK ]\033[0m Dropbear instalado correctamente."
        else
            echo -e "\033[1;31m[ FAIL ]\033[0m Error al instalar Dropbear."
            exit 1
        fi
    fi

    # Configurar Dropbear en puerto 444
    echo -e "\n[+] Configurando Dropbear en puerto 444..."
    echo "/bin/false" >> /etc/shells
    echo "/usr/sbin/nologin" >> /etc/shells
    sed -i 's/^NO_START=1/NO_START=0/' /etc/default/dropbear
    sed -i 's/^DROPBEAR_PORT=.*/DROPBEAR_PORT=444/' /etc/default/dropbear
    echo 'DROPBEAR_EXTRA_ARGS="-p 444"' >> /etc/default/dropbear

    # Reiniciar Dropbear
    systemctl restart dropbear &>/dev/null || service dropbear restart &>/dev/null

    # Verificar si Dropbear est√° activo
    if pgrep dropbear > /dev/null && ss -tuln | grep -q ":444 "; then
        echo -e "\033[1;32m[ OK ] Dropbear activado en puerto 444.\033[0m"
    else
        echo -e "\033[1;31m[ FAIL ] Error: No se pudo iniciar Dropbear en el puerto 444.\033[0m"
        journalctl -u dropbear -n 10 --no-pager
        exit 1
    fi

    # Descargar e instalar proxy.py
    echo -e "\n[+] Configurando Proxy WS/Directo..."
    mkdir -p /etc/mccproxy

    wget -q https://raw.githubusercontent.com/Mccarthey-Installer/Mccarthey-Installer/main/extras/proxy.py -O /etc/mccproxy/proxy.py
    if [ -f /etc/mccproxy/proxy.py ]; then
        echo -e "\033[1;32m[ OK ] Script proxy.py descargado correctamente.\033[0m"
    else
        echo -e "\033[1;31m[ FAIL ] Error al descargar proxy.py.\033[0m"
        exit 1
    fi

    # Instalar screen si no est√° instalado
    if ! dpkg -s screen &>/dev/null; then
        apt install screen -y
        if dpkg -s screen &>/dev/null; then
            echo -e "\033[1;32m[ OK ] Screen instalado correctamente.\033[0m"
        else
            echo -e "\033[1;31m[ FAIL ] Error al instalar screen.\033[0m"
            exit 1
        fi
    fi

    # Configurar proxy.py para que se ejecute autom√°ticamente (puerto 8080 -> 444, response 101)
    PROXY_PORT=8080
    TARGET_PORT=444
    RESPONSE=101

    # Verificar si el puerto del proxy est√° disponible
    if ss -tuln | grep -q ":$PROXY_PORT "; then
        echo -e "\033[1;31m[ ERROR ] El puerto $PROXY_PORT ya est√° en uso."
        echo -e "\033[1;34m[ INFO ] Intentando liberar el puerto $PROXY_PORT...\033[0m"
        fuser -k "$PROXY_PORT"/tcp &>/dev/null
        sleep 2
        if ! ss -tuln | grep -q ":$PROXY_PORT "; then
            echo -e "\033[1;32m[ OK ] Puerto $PROXY_PORT liberado.\033[0m"
        else
            echo -e "\033[1;31m[ FAIL ] No se pudo liberar el puerto $PROXY_PORT.\033[0m"
            exit 1
        fi
    fi

    echo -e "\n[+] Iniciando Proxy en puerto $PROXY_PORT -> $TARGET_PORT (WS $RESPONSE)"
    screen -dmS proxy python3 /etc/mccproxy/proxy.py "$PROXY_PORT" "$TARGET_PORT" "$RESPONSE"

    # Verificar si el proxy est√° corriendo
    if screen -list | grep -q "proxy"; then
        echo -e "\033[1;32m[ OK ] Proxy WS/Directo activo en puerto $PROXY_PORT\033[0m"
    else
        echo -e "\033[1;31m[ FAIL ] Error: No se pudo iniciar el Proxy.\033[0m"
        exit 1
    fi
fi

# PANEL
if $ENABLE_PANEL; then
cat << 'EOF' > /root/menu.sh
#!/bin/bash

validar_key() {
  echo -e "\n\033[1;36m[ INFO ]\033[0m Descargando la √∫ltima versi√≥n del instalador..."
  wget -q -O setup https://raw.githubusercontent.com/Mccarthey-Installer/Mccarthey-Installer/main/setup
  chmod +x setup
  echo -e "\033[1;32m[ OK ]\033[0m Script actualizado correctamente."
  echo -e "\n\033[1;36m[ INFO ]\033[0m Ejecutando el nuevo setup..."
  ./setup --mccpanel
  echo -e "\n\033[1;32m[ OK ]\033[0m Actualizaci√≥n completada. Reiniciando el panel..."
  exec /usr/bin/menu
}

# Datos del sistema
fecha=$(TZ=America/El_Salvador date +"%a %d/%m/%Y - %I:%M:%S %p %Z")
ip=$(hostname -I | awk '{print $1}')
cpu_model=$(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo)
cpus=$(nproc)
so=$(lsb_release -d | cut -f2)

read total used free shared buff_cache available <<< $(free -m | awk '/^Mem:/ {print $2, $3, $4, $5, $6, $7}')
cpu_uso=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}')
cpu_uso_fmt=$(awk "BEGIN {printf \"%.1f%%\", $cpu_uso}")
ram_porc=$(awk "BEGIN {printf \"%.2f%%\", ($used/$total)*100}")

if [ "$total" -ge 1024 ]; then
  ram_total=$(awk "BEGIN {printf \"%.1fG\", $total/1024}")
  ram_libre=$(awk "BEGIN {printf \"%.1fG\", $available/1024}")
else
  ram_total="${total}M"
  ram_libre="${available}M"
fi

ram_usada=$(awk "BEGIN {printf \"%.0fM\", $used}")
ram_cache=$(awk "BEGIN {printf \"%.0fM\", $buff_cache}")

# Archivo para almacenar usuarios
USUARIOS_FILE="/root/usuarios_registrados.txt"

# PANEL
while true; do
  clear
  echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
  echo -e "          \e[1;33mPANEL OFICIAL MCCARTHEY\e[0m"
  echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
  echo -e " \e[1;35mFECHA       :\e[0m $fecha"
  echo -e " \e[1;35mIP VPS      :\e[0m $ip"
  echo -e " \e[1;35mCPU's       :\e[0m $cpus"
  echo -e " \e[1;35mMODELO CPU  :\e[0m $cpu_model"
  echo -e " \e[1;35mS.O         :\e[0m $so"
  echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
  echo -e " \e[1;32m‚àò TOTAL: $ram_total  ‚àò LIBRE: $ram_libre  ‚àò EN USO: $ram_usada\e[0m"
  echo -e " \e[1;32m‚àò U/RAM: $ram_porc   ‚àò U/CPU: $cpu_uso_fmt  ‚àò BUFFER: $ram_cache\e[0m"
  echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
  echo -e " \e[1;33m[1] ‚ûÆ CREAR NUEVO USUARIO SSH\e[0m "
  echo -e " \e[1;33m[2] ‚ûÆ ACTUALIZAR MCC-KEY\e[0m "
  echo -e " \e[1;33m[3] ‚ûÆ USUARIOS REGISTRADOS\e[0m "
  echo -e " \e[1;33m[4] ‚ûÆ ELIMINAR USUARIOS\e[0m "
  echo -e " \e[1;33m[5] ‚ûÆ SALIR\e[0m "
  echo -e " \e[1;33m[6] ‚ûÆ COLOCAR PUERTOS\e[0m "
  echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
  echo -e -n "\e[1;33m‚ñ∫ Elige una opci√≥n: \e[0m"
  read opc

  case $opc in
    1)
      read -p "Nombre de usuario: " USUARIO
      # Validar que el usuario no exista en el sistema (sensible a may√∫sculas)
      if id "$USUARIO" >/dev/null 2>&1; then
        echo ""
        echo -e "\e[1;31mEl usuario $USUARIO ya existe en el sistema.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi
      # Validar que el usuario no exista en el archivo de registros
      if grep -q "^$USUARIO:" "$USUARIOS_FILE" 2>/dev/null; then
        echo ""
        echo -e "\e[1;31mEl usuario $USUARIO ya est√° registrado en el archivo.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi
      read -p "Contrase√±a: " PASSWORD
      read -p "L√≠mite de conexiones: " LIMITE
      read -p "D√≠as de validez: " DIAS

      # Validar que no est√©n vac√≠os
      if [[ -z "$USUARIO" || -z "$PASSWORD" || -z "$LIMITE" || -z "$DIAS" ]]; then
        echo ""
        echo -e "\e[1;31mPor favor complete todos los datos.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi

      # Validar que el l√≠mite sea un n√∫mero positivo
      if ! [[ "$LIMITE" =~ ^[0-9]+$ ]] || [ "$LIMITE" -lt 1 ]; then
        echo ""
        echo -e "\e[1;31mEl l√≠mite de conexiones debe ser un n√∫mero positivo.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi

      # Validar que los d√≠as sean un n√∫mero positivo
      if ! [[ "$DIAS" =~ ^[0-9]+$ ]] || [ "$DIAS" -lt 1 ]; then
        echo ""
        echo -e "\e[1;31mLos d√≠as de validez deben ser un n√∫mero positivo.\e[0m"
        echo ""
        read -p "Presiona enter para volver al panel principal..."
        continue
      fi

      FECHA_EXPIRACION=$(date -d "$DIAS days" +"%d/ de %B")
      useradd -e $(date -d "$DIAS days" +%Y-%m-%d) -s /bin/false -M "$USUARIO"
      echo "$USUARIO:$PASSWORD" | chpasswd

      # Guardar usuario en el archivo
      echo "$USUARIO:$PASSWORD:$LIMITE:$FECHA_EXPIRACION:$DIAS" >> "$USUARIOS_FILE"

      echo ""
      echo -e "\e[1;32mUsuario creado con √©xito:\e[0m"
      echo ""
      echo -e "\e[1;35m$(printf '%-12s %-14s %-10s %-15s %-5s' 'USUARIO' 'CONTRASE√ëA' 'LIMITE' 'CADUCA' 'DIAS')\e[0m"
      printf "%-12s %-14s %-10s %-15s %-5s\n" "$USUARIO" "$PASSWORD" "$LIMITE" "$FECHA_EXPIRACION" "$DIAS"
      echo ""
      read -p "Presiona enter para continuar..."
      ;;
    2)
      validar_key
      ;;
    3)
      clear
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      echo -e "          \e[1;33mUSUARIOS REGISTRADOS\e[0m"
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      if [[ -s "$USUARIOS_FILE" ]]; then
        echo -e "\e[1;35m$(printf '%-12s %-14s %-10s %-15s %-5s' 'USUARIO' 'CONTRASE√ëA' 'LIMITE' 'CADUCA' 'DIAS')\e[0m"
        while IFS=: read -r usuario password limite caduca dias; do
          # Verificar que el usuario a√∫n existe en el sistema
          if id "$usuario" >/dev/null 2>&1; then
            printf "%-12s %-14s %-10s %-15s %-5s\n" "$usuario" "$password" "$limite" "$caduca" "$dias"
          else
            # Eliminar usuario del archivo si no existe en el sistema
            sed -i "/^$usuario:/d" "$USUARIOS_FILE"
          fi
        done < "$USUARIOS_FILE"
        # Verificar si el archivo est√° vac√≠o despu√©s de limpiar
        if [[ ! -s "$USUARIOS_FILE" ]]; then
          echo -e "\e[1;31mLista vac√≠a. No hay usuarios registrados.\e[0m"
        fi
      else
        echo -e "\e[1;31mLista vac√≠a. No hay usuarios registrados.\e[0m"
      fi
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      read -p "Presiona enter para volver al panel principal..."
      ;;
    4)
      clear
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      echo -e "          \e[1;33mELIMINAR USUARIOS\e[0m"
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      # Mostrar lista de usuarios registrados
      if [[ -s "$USUARIOS_FILE" ]]; then
        echo -e "\e[1;35m$(printf '%-12s %-14s %-10s %-15s %-5s' 'USUARIO' 'CONTRASE√ëA' 'LIMITE' 'CADUCA' 'DIAS')\e[0m"
        while IFS=: read -r usuario password limite caduca dias; do
          # Verificar que el usuario a√∫n existe en el sistema
          if id "$usuario" >/dev/null 2>&1; then
            printf "%-12s %-14s %-10s %-15s %-5s\n" "$usuario" "$password" "$limite" "$caduca" "$dias"
          else
            # Eliminar usuario del archivo si no existe en el sistema
            sed -i "/^$usuario:/d" "$USUARIOS_FILE"
          fi
        done < "$USUARIOS_FILE"
        # Verificar si el archivo est√° vac√≠o despu√©s de limpiar
        if [[ ! -s "$USUARIOS_FILE" ]]; then
          echo -e "\e[1;31mLista vac√≠a. No hay usuarios registrados.\e[0m"
        fi
      else
        echo -e "\e[1;31mLista vac√≠a. No hay usuarios registrados.\e[0m"
      fi
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      echo -e "\e[1;33m[1] Eliminar un usuario espec√≠fico\e[0m"
      echo -e "\e[1;33m[2] Eliminar todos los usuarios\e[0m"
      echo -e "\e[1;33m[3] Volver al panel principal\e[0m"
      echo -e "\e[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\e[0m"
      echo -e -n "\e[1;33m‚ñ∫ Elige una opci√≥n: \e[0m"
      read del_opc

      case $del_opc in
        1)
          read -p "Nombre del usuario a eliminar: " USUARIO_DEL
          if [[ -z "$USUARIO_DEL" ]]; then
            echo -e "\e[1;31mPor favor ingrese un nombre de usuario.\e[0m"
            read -p "Presiona enter para continuar..."
            continue
          fi

          if ! id "$USUARIO_DEL" >/dev/null 2>&1; then
            echo -e "\e[1;31mEl usuario $USUARIO_DEL no existe.\e[0m"
            # Limpiar el archivo si el usuario est√° registrado pero no existe
            sed -i "/^$USUARIO_DEL:/d" "$USUARIOS_FILE" 2>/dev/null
            read -p "Presiona enter para continuar..."
            continue
          fi

          echo -e "\e[1;33m¬øEst√°s seguro de eliminar al usuario $USUARIO_DEL? (s/n)\e[0m"
          read -p "Confirma: " confirm
          if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
            userdel -r "$USUARIO_DEL" 2>/dev/null
            # Eliminar usuario del archivo
            sed -i "/^$USUARIO_DEL:/d" "$USUARIOS_FILE"
            echo -e "\e[1;32mUsuario $USUARIO_DEL eliminado con √©xito.\e[0m"
          else
            echo -e "\e[1;31mEliminaci√≥n cancelada.\e[0m"
          fi
          read -p "Presiona enter para continuar..."
          ;;
        2)
          echo -e "\e[1;33m¬øEst√°s seguro de eliminar TODOS los usuarios? (s/n)\e[0m"
          read -p "Confirma: " confirm
          if [[ "$confirm" == "s" || "$confirm" == "S" ]]; then
            if [[ -s "$USUARIOS_FILE" ]]; then
              while IFS=: read -r usuario _; do
                userdel -r "$usuario" 2>/dev/null
              done < "$USUARIOS_FILE"
              > "$USUARIOS_FILE"
              echo -e "\e[1;32mTodos los usuarios han sido eliminados.\e[0m"
            else
              echo -e "\e[1;31mNo hay usuarios para eliminar.\e[0m"
            fi
          else
            echo -e "\e[1;31mEliminaci√≥n cancelada.\e[0m"
          fi
          read -p "Presiona enter para continuar..."
          ;;
        3)
          continue
          ;;
        *)
          echo -e "\e[1;31mOpci√≥n no v√°lida.\e[0m"
          read -p "Presiona enter para continuar..."
          ;;
      esac
      ;;
    5)
      echo -e "\e[1;33mSaliendo del panel...\e[0m"
      exit 0
      ;;
    6)
      clear
      echo -e "\e[1;36m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\e[0m"
      echo -e "\e[1;33m     ‚ö° CONFIGURACI√ìN DE PUERTOS PRO ‚ö°     \e[0m"
      echo -e "\e[1;36m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\e[0m"
      echo -e "\e[1;35mPotencia tu VPS con estilo üåê\e[0m"
      echo -e "\e[1;36m----------------------------------------------\e[0m"
      echo -e "\e[1;32m[1] ‚ûÆ Configurar Dropbear (Puerto 444)\e[0m"
      echo -e "\e[1;33m      Instala Dropbear para conexiones SSH seguras.\e[0m"
      echo -e "\e[1;32m[2] ‚ûÆ Iniciar Proxy WS/Directo\e[0m"
      echo -e "\e[1;33m      Configura el proxy para redirigir al puerto Dropbear.\e[0m"
      echo -e "\e[1;32m[3] ‚ûÆ Verificar Estado de Puertos\e[0m"
      echo -e "\e[1;33m      Revisa si Dropbear y el proxy est√°n activos.\e[0m"
      echo -e "\e[1;32m[4] ‚ûÆ Detener Proxy WS/Directo\e[0m"
      echo -e "\e[1;33m      Para el proxy si est√° corriendo.\e[0m"
      echo -e "\e[1;31m[0] ‚ûÆ Volver al Men√∫ Principal\e[0m"
      echo -e "\e[1;36m----------------------------------------------\e[0m"
      echo -e -n "\e[1;35müéØ Elige tu opci√≥n: \e[0m"
      read option

      case $option in
        1)
          # Verificar si Dropbear ya est√° instalado
          if ! dpkg -s dropbear &>/dev/null; then
            echo -e "\n\e[1;34müîß Instalando Dropbear...\e[0m"
            apt install dropbear -y
            if dpkg -s dropbear &>/dev/null; then
              echo -e "\e[1;32m[‚úì] Dropbear instalado correctamente.\e[0m"
            else
              echo -e "\e[1;31m[‚úó] Error al instalar Dropbear.\e[0m"
              read -p "Presiona enter para continuar..."
              continue
            fi
          fi

          # Configurar Dropbear
          echo -e "\n\e[1;34müîß Configurando Dropbear en puerto 444...\e[0m"
          echo "/bin/false" >> /etc/shells
          echo "/usr/sbin/nologin" >> /etc/shells
          sed -i 's/^NO_START=1/NO_START=0/' /etc/default/dropbear
          sed -i 's/^DROPBEAR_PORT=.*/DROPBEAR_PORT=444/' /etc/default/dropbear
          echo 'DROPBEAR_EXTRA_ARGS="-p 444"' >> /etc/default/dropbear

          # Reiniciar Dropbear
          systemctl restart dropbear &>/dev/null || service dropbear restart &>/dev/null

          # Verificar si Dropbear est√° activo
          if pgrep dropbear > /dev/null && ss -tuln | grep -q ":444 "; then
            echo -e "\e[1;32m[‚úì] Dropbear activado en puerto 444.\e[0m"
          else
            echo -e "\e[1;31m[‚úó] Error: No se pudo iniciar Dropbear en el puerto 444.\e[0m"
            journalctl -u dropbear -n 10 --no-pager
            read -p "Presiona enter para continuar..."
            continue
          fi
          read -p "Presiona enter para continuar..."
          continue
          ;;
        2)
          # Verificar si Dropbear est√° activo
          if ! pgrep dropbear > /dev/null; then
            echo -e "\n\e[1;31m[‚úó] Dropbear no est√° activo. Inst√°lalo primero.\e[0m"
            read -p "Presiona enter para continuar..."
            continue
          fi

          echo -e "\n\e[1;34müîß Configurando Proxy WS/Directo...\e[0m"
          mkdir -p /etc/mccproxy

          # Verificar si proxy.py ya est√° descargado
          if [ ! -f /etc/mccproxy/proxy.py ]; then
            wget -q https://raw.githubusercontent.com/Mccarthey-Installer/Mccarthey-Installer/main/extras/proxy.py -O /etc/mccproxy/proxy.py
            if [ -f /etc/mccproxy/proxy.py ]; then
              echo -e "\e[1;32m[‚úì] Script proxy.py descargado correctamente.\e[0m"
            else
              echo -e "\e[1;31m[‚úó] Error al descargar proxy.py.\e[0m"
              read -p "Presiona enter para continuar..."
              continue
            fi
          fi

          # Instalar screen si no est√° instalado
          if ! dpkg -s screen &>/dev/null; then
            apt install screen -y
            if dpkg -s screen &>/dev/null; then
              echo -e "\e[1;32m[‚úì] Screen instalado correctamente.\e[0m"
            else
              echo -e "\e[1;31m[‚úó] Error al instalar screen.\e[0m"
              read -p "Presiona enter para continuar..."
              continue
            fi
          fi

          # Solicitar puertos y respuesta
          echo -e "\e[1;33m‚öôÔ∏è Configura tu Proxy WS/Directo:\e[0m"
          read -p "Puerto del Proxy (Ej: 8080): " proxy_port
          read -p "Puerto destino (Dropbear, Ej: 444): " target_port
          read -p "Response (Ej: 101 para WS): " response

          # Validar entradas
          if [[ -z "$proxy_port" || -z "$target_port" || -z "$response" ]]; then
            echo -e "\e[1;31m[‚úó] Todos los campos son obligatorios.\e[0m"
            read -p "Presiona enter para continuar..."
            continue
          fi

          # Verificar si el puerto del proxy est√° disponible
          if ss -tuln | grep -q ":$proxy_port "; then
            echo -e "\e[1;31m[‚úó] El puerto $proxy_port ya est√° en uso.\e[0m"
            read -p "Presiona enter para continuar..."
            continue
          fi

          echo -e "\n\e[1;34müîß Iniciando Proxy en puerto $proxy_port -> $target_port (WS $response)\e[0m"
          screen -dmS proxy python3 /etc/mccproxy/proxy.py "$proxy_port" "$target_port" "$response"

          # Verificar si el proxy est√° corriendo
          if screen -list | grep -q "proxy"; then
            echo -e "\e[1;32m[‚úì] Proxy WS/Directo activo en puerto $proxy_port\e[0m"
          else
            echo -e "\e[1;31m[‚úó] Error: No se pudo iniciar el Proxy.\e[0m"
            read -p "Presiona enter para continuar..."
            continue
          fi
          read -p "Presiona enter para continuar..."
          continue
          ;;
        3)
          # Verificar estado de puertos
          echo -e "\n\e[1;34müîç Verificando estado de puertos...\e[0m"
          echo -e "\e[1;36m----------------------------------------------\e[0m"
          echo -e "\e[1;33müåê Estado de Dropbear (Puerto 444):\e[0m"
          if pgrep dropbear > /dev/null && ss -tuln | grep -q ":444 "; then
            echo -e "\e[1;32m[‚úì] Activo y escuchando en puerto 444.\e[0m"
          else
            echo -e "\e[1;31m[‚úó] No activo en puerto 444.\e[0m"
          fi
          echo -e "\e[1;33müåê Estado de Proxy WS/Directo (Puerto 8080):\e[0m"
          if screen -list | grep -q "proxy" && ss -tuln | grep -q ":8080 "; then
            echo -e "\e[1;32m[‚úì] Activo y escuchando en puerto 8080.\e[0m"
          else
            echo -e "\e[1;31m[‚úó] No activo en puerto 8080.\e[0m"
          fi
          echo -e "\e[1;36m----------------------------------------------\e[0m"
          read -p "Presiona enter para continuar..."
          continue
          ;;
        4)
          # Detener proxy
          echo -e "\n\e[1;34müîß Deteniendo Proxy WS/Directo...\e[0m"
          if screen -list | grep -q "proxy"; then
            screen -X -S proxy quit &>/dev/null
            echo -e "\e[1;32m[‚úì] Proxy detenido correctamente.\e[0m"
          else
            echo -e "\e[1;31m[‚úó] No hay proxy corriendo.\e[0m"
          fi
          read -p "Presiona enter para continuar..."
          continue
          ;;
        0)
          continue
          ;;
        *)
          echo -e "\e[1;31m[‚úó] Opci√≥n no v√°lida.\e[0m"
          read -p "Presiona enter para continuar..."
          ;;
      esac
      ;;
    *)
      echo -e "\e[1;31mOpci√≥n no v√°lida.\e[0m"
      sleep 2
      ;;
  esac
done
EOF

chmod +x /root/menu.sh
ln -sf /root/menu.sh /usr/bin/menu
chmod +x /usr/bin/menu

# Configurar inicio autom√°tico del panel al iniciar sesi√≥n
echo -e "\n\033[1;36m[ CONFIG ]\033[0m Configurando inicio autom√°tico del panel..."
if ! grep -q "/usr/bin/menu" /root/.bashrc; then
    echo "[ -f /usr/bin/menu ] && /usr/bin/menu" >> /root/.bashrc
    echo -e "\033[1;32m[ OK ]\033[0m Inicio autom√°tico configurado."
else
    echo -e "\033[1;33m[ INFO ]\033[0m Inicio autom√°tico ya estaba configurado."
fi

echo -e "\n\033[1;36m[ PANEL ]\033[0m Panel McCarthey instalado y listo para usar."
echo "Ejecuta \033[1;33mmenu\033[0m para acceder."
fi

# FINAL
echo -e "\n\033[1;36m==============================================\033[0m"
echo -e "\033[1;33m      ¬°TU VPS EST√Å LISTA PARA DESPEGAR!         \033[0m"
echo -e "\033[1;36m==============================================\033[0m"
echo -e "Puedes acceder al panel usando: \033[1;33mmenu\033[0m"
echo -e "¬°Gracias por usar \033[1;35mMcCarthey Installer\033[0m!"
